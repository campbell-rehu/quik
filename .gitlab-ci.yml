stages:
  - test
  - build
  - docker-branch
  - docker-release
  - deploy

test-fe:
  image: node:13.12.0-alpine
  stage: test
  rules:
    - changes:
      - 'src/*'
  script:
    - npm install
    - CI=true npm test

build-fe:
  image: node:13.12.0-alpine
  stage: build
  environment: production
  rules:
    - changes:
      - 'src/*'
  script:
    - npm install
    - SERVER=$QUIK_SERVER_URL BUILD_PATH=./fe-build npm run build
  artifacts:
    paths:
      - 'fe-build/'
    expire_in: 3 days

docker_front_end_image_build_branch:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: ['']
  stage: docker-branch
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
      changes:
        - 'src/*'
      when: always
  environment: production
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE/quik-fe:CI_COMMIT_BRANCH

docker_front_end_image_build_release:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: ['']
  stage: docker-release
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - 'src/*'
      when: always
  environment: production
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE/quik-fe:latest

build-be:
  image: node:16.17.1-alpine3.15
  stage: build
  environment: production
  rules:
    - changes:
      - 'server/*'
  script:
    - cd server/
    - npm install
    - NODE_ENV=production npm run build
  artifacts:
    paths:
      - 'server/dist/'
    expire_in: 3 days

docker_back_end_image_build_branch:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: ['']
  stage: docker-branch
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
      changes:
        - 'server/*'
      when: always
  environment: production
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR/server --dockerfile $CI_PROJECT_DIR/server/Dockerfile --destination $CI_REGISTRY_IMAGE/quik-be:$CI_COMMIT_BRANCH

docker_back_end_image_build_release:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: ['']
  stage: docker-release
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - 'server/*'
      when: always
  environment: production
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR/server --dockerfile $CI_PROJECT_DIR/server/Dockerfile --destination $CI_REGISTRY_IMAGE/quik-be:latest

deploy-prod:
  stage: deploy
  script:
    - echo "This job deploys something from the $CI_COMMIT_BRANCH branch."
  environment: production
